<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>VISUALIZADOR 3D - TEST</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            margin: 0;
            overflow: hidden;
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        button {
            padding: 20px 40px;
            font-size: 24px;
            background: #0f0;
            color: #000;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
        }

        button:hover {
            background: #0a0;
        }

        #console {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 400px;
            height: 150px;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #0f0;
            padding: 10px;
            font-size: 12px;
            overflow-y: auto;
            z-index: 1000;
        }

        .err {
            color: #f55;
        }
    </style>
</head>

<body>

    <div id="overlay">
        <h1>Visualizador Fase 1</h1>
        <p>Haz clic para iniciar la cámara y el motor 3D</p>
        <button id="startBtn">INICIAR VISUALIZADOR</button>
    </div>

    <div id="console"></div>

    <script src="three.min.js"></script>

    <script>
        const log = (msg, isErr = false) => {
            const d = document.createElement('div');
            if (isErr) d.className = 'err';
            d.textContent = `> ${msg}`;
            const c = document.getElementById('console');
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        };

        document.getElementById('startBtn').onclick = async () => {
            document.getElementById('overlay').style.display = 'none';
            log("Iniciando...");

            if (typeof THREE === 'undefined') {
                log("ERROR: Three.js no cargó!", true);
                return;
            }

            try {
                log("Pidiendo cámara...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                await video.play();
                log("Cámara conectada.");

                // Setup Three.js
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.z = 250;

                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                // Nube de puntos
                const w = 120, h = 90; // Resolución menor para asegurar 60fps
                const geo = new THREE.BufferGeometry();
                const pos = new Float32Array(w * h * 3);
                const col = new Float32Array(w * h * 3);

                for (let i = 0; i < w * h; i++) {
                    pos[i * 3] = (i % w) - w / 2;
                    pos[i * 3 + 1] = -(Math.floor(i / w)) + h / 2;
                    pos[i * 3 + 2] = 0;
                    col[i * 3 + 1] = 1;
                }
                geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
                geo.setAttribute('color', new THREE.BufferAttribute(col, 3));

                const points = new THREE.Points(geo, new THREE.PointsMaterial({ size: 2, vertexColors: true }));
                scene.add(points);

                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');

                log("Renderizando...");

                function loop() {
                    ctx.drawImage(video, 0, 0, w, h);
                    const img = ctx.getImageData(0, 0, w, h).data;
                    const pArray = geo.attributes.position.array;
                    const cArray = geo.attributes.color.array;

                    for (let i = 0; i < w * h; i++) {
                        const b = (img[i * 4] + img[i * 4 + 1] + img[i * 4 + 2]) / 3 / 255;
                        pArray[i * 3 + 2] = b * 100;
                        cArray[i * 3 + 1] = 0.4 + b * 0.6;
                    }
                    geo.attributes.position.needsUpdate = true;
                    geo.attributes.color.needsUpdate = true;
                    points.rotation.y += 0.005;

                    renderer.render(scene, camera);
                    requestAnimationFrame(loop);
                }
                loop();

            } catch (e) {
                log("ERROR: " + e.message, true);
            }
        };
    </script>
</body>

</html>